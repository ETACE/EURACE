\subsection{Assessment and Benchmarking for the EURACE Model}
\label{sec:benchmarks}
In this section we consider the benchmarking of the full EURACE Model as
described in the other deliverables of the project. Before presenting the
results of the benchmarks it is useful to consider what we are measuring
and why. The goal of most performance analyses is to identify sections
or elements of a program that are taking significant resourses - computational
time - with the aim of optimising these to reduce the total elapsed time
of the simulation. Our purpose is no different from this expect that we
will be considering both serial and parallel performance.

It goes without saying that there is little point assessing the parallel
performance of a code that performing poorly in serial mode. Most of the
components of the code will be executed in both modes although there
may be re-organisation of the control flow. So we start will an analysis
of the serial version of the EURACE Model.

When assessing parallel performance two basic laws influence the developer:
Amdalh's Law and Gustafson's Law. Amdahl's law is a model for the relationship 
between the expected speedup of parallelized implementations of an algorithm 
relative to the serial algorithm, under the assumption that the problem size 
remains the same when parallelized.

Amdahl's law states that if $P$ is the proportion of a program that can be made 
parallel (i.e. benefit from parallelization), and $(1 - P)$ is the proportion 
that cannot be parallelized (remains serial), then the maximum speedup that can 
be achieved by using $N$ processors is
\begin{equation}
	    \frac{1}{(1-P) + \frac{P}{N}}.
\end{equation}
In the limit, as $N$ tends to infinity, the maximum speedup tends to 
${1}/{(1 - P)}$. In practice, performance to price ratio falls rapidly as 
$N$ is increased once there is even a small component of $(1 - P)$.

As an example, if $P$ is $90\%$, then $(1 - P)$ is $10\%$, and the problem 
can be speed up by a maximum of a factor of $10$, no matter how large the 
value of $N$ used. For this reason, it has been often said, parallel computing 
is only useful for either small numbers of processors, or problems with very 
high values of $P$: so-called embarrassingly parallel problems. A great part 
of the craft of parallel programming consists of attempting to reduce the 
component $(1 – P)$ to the smallest possible value.

Fortunately this is not the end of parallel computing. It must be noted that
this was for a \textbf{fixed size} application.  Gustafson's Law paints a
different picture. It states that any sufficiently large problem can be 
efficiently parallelized and the speedup that can be gained is:
\begin{equation}
	S(P) = P - \alpha\cdot(P-1)
\end{equation}
where $P$ is the number of processors, $S$ is the speedup, and $\alpha$ the non-parallelizable part of the process.

Gustafson's law addresses the shortcomings of Amdahl's law, which cannot scale to match availability of computing power as the machine size increases. It removes the fixed problem size or fixed computation load on the parallel processors: instead, he proposed a fixed time concept which leads to scaled speed up for larger problem sizes (i.e. weak or soft scaling).

Amdahl's law is based on fixed workload or fixed problem size (i.e. strong or hard scaling). It implies that the sequential part of a program does not change with respect to machine size (i.e, the number of processors). However the parallel part is evenly distributed by $N$ processors.

In both of these formalisations of potential parallel speedup to proportional of serial activity has a significant effect of the potential parallel speedup. However Gustason's Law gives the hope that for
a \textit{sufficiently large} problem parallel performance can be demonstrated.

We have developed a number of analysis tools that have allowed us to benchmark any
FLAME model and assess its serial and parallel performance. We have used a number 
of versions of the EURACE Model in this benchmarking - the model has been under 
constant development.

\subsection{Serial Performance Analysis}

This section comprises tables of agent function CPU times recorded with the timer package as the EURACE integrated model has evolved in recent revisions. The code was compiled with debugging and profiling turned on which will have an effect on the absolute timings but not on the proportion of time spent in each routine. 

At the start of this analysis (Table \ref{table:r2701}) one clearinghouse agent function took up 72\% of the run time. When this function was profiled with the GNU \texttt{gprof} tool (see Figure \ref{fig:CH_call_graph}) it was found that the algorithm implemented in \texttt{newPrice} could be improved in a number of ways which would lead to a halving of the number of calls to \texttt{aggregateDemand}.  The improvements were passed on to the modellers and were incroporated into a new version of the code. 

These changes significantly lowered the time taken by the clearinghouse and this was enough to bring the second placed function in Table \ref{table:r2701} to the top in Table \ref{table:r2723}.

\begin{figure}
\begin{verbatim}
 ClearingHouse_receive_orders_and_run (73.5%, called 40 times)
   +----emptyClearing
   +----receiveOrderOnAsset
   | +----setOrder
   | +----isBuyOrder
   | +----addBuyOrder
   | | +----addOrder
   | +----isSellOrder
   | +----addSellOrder
   |   +----setAsSellOrder
   |   | +----getOrderQuantity
   |   +----addOrder
   +----computeAssetPrice (72%, called 2040 times)
   | +----setClearingMechanism
   | +----lastPrice
   | +----runClearing (72%, called 2040 times)
   | | +----buyOrders
   | | +----sellOrders
   | | +----sortOrders
   | | +----newPrice (71.2%, called 2040 times)
   | | | +----aggregateDemand (69.25%, called 4,495,474 times)
   | | | +----aggregateSupply (2%,     called 4,495,474 times)
   | | +----aggregateDemand
   | | +----aggregateSupply
   | | +----ordersMacthing
   | | | +----addOrder
   | | +----rationing
   | |   +----randomize
   | |   +----removeZeroOrders
   | +----addPrice
   | +----addVolume
   +----sendOrderStatus
     +----buyOrders
     +----formedPrice
     +----sellOrders\end{verbatim}
\caption{Call graph for \texttt{ClearingHouse$\_$receive$\_$orders$\_$and$\_$run} showing work done in most expensive call path\label{fig:CH_call_graph}}
\end{figure}

\begin{landscape}

\begin{table}
\begin{center}
{\small\renewcommand{\arraystretch}{1.3}
\begin{tabular}{|p{70mm}|p{70mm}|p{70mm}|c|c|}\hline
Function & State from & State to & Time (s) & \% \\ \hline
ClearingHouse$\_$receive$\_$orders$\_$and$\_$run & RECEIVEDINFOSTOCK & COMPUTEDPRICES &  82.81 & 72 \\ \hline
Household$\_$stock$\_$beliefs$\_$formation & CHOOSE$\_$TO$\_$UPDATE$\_$BELIEFS$\_$OR$\_$NOT & BOND$\_$BELIEF$\_$FORMATION &  25.32 & 22 \\ \hline
Household$\_$send$\_$orders & SEND$\_$ORDERS & WAITORDERSTATUS &  2.06 & 1.7 \\ \hline
Household$\_$bond$\_$beliefs$\_$formation & BOND$\_$BELIEF$\_$FORMATION &SEND$\_$ORDERS &  0.44 & 0.38 \\ \hline
Household$\_$rank$\_$and$\_$buy$\_$goods$\_$1 & 09 & 09b &  0.42 & 0.36 \\ \hline
\parbox[t]{6cm}{Firm$\_$read$\_$job$\_$applications$\_$send$\_$\\[-4pt]job$\_$offer$\_$or$\_$rejection} & 03 & 04 &  0.37 & 0.32 \\ \hline
Household$\_$update$\_$its$\_$portfolio & WAITORDERSTATUS & Household$\_$Start$\_$Labour$\_$Role &  0.16 & 0.14 \\ \hline
Household$\_$receive$\_$dividends & 06 & 06b &  0.11 & $<$0.1 \\ \hline
Household$\_$receive$\_$info$\_$interest$\_$from$\_$bank & Household$\_$received$\_$coupons & SELECTSTRATEGY &  0.09 & $<$0.1 \\ \hline
Household$\_$send$\_$account$\_$update & 15 & 16 &  0.09 & $<$0.1 \\ \hline
\end{tabular}
}
\caption{Revision \textbf{2701}, Serial, 40 iterations, small population. Total run time 1:55[m:s]\label{table:r2701}}
\end{center}
\end{table}


\begin{table}
\begin{center}
{\small\renewcommand{\arraystretch}{1.3}
\begin{tabular}{|p{70mm}|p{70mm}|p{70mm}|c|c|}\hline
Function & State from & State to & Time (s) & \% \\ \hline
Household$\_$stock$\_$beliefs$\_$formation & CHOOSE$\_$TO$\_$UPDATE$\_$BELIEFS$\_$OR$\_$NOT & BOND$\_$BELIEF$\_$FORMATION &  245.78 & 61 \\ \hline
Household$\_$send$\_$orders & SEND$\_$ORDERS & WAITORDERSTATUS &  46.44 & 11 \\ \hline
ClearingHouse$\_$receive$\_$orders$\_$and$\_$run & RECEIVEDINFOSTOCK & COMPUTEDPRICES &  41.76 & 10 \\ \hline
Household$\_$bond$\_$beliefs$\_$formation & BOND$\_$BELIEF$\_$FORMATION &SEND$\_$ORDERS &  4.98 & 1.2 \\ \hline
Household$\_$update$\_$its$\_$portfolio & WAITORDERSTATUS & Household$\_$Start$\_$Labour$\_$Role &  1.48 & 0.3 \\ \hline
Household$\_$rank$\_$and$\_$buy$\_$goods$\_$1 & 09 & 09b &  1.04 & 0.28 \\ \hline
Household$\_$rank$\_$and$\_$buy$\_$goods$\_$2 & 11 & 12 &  0.9 & 0.22 \\ \hline
Household$\_$receive$\_$dividends & 06 & 06b &  0.8 & 0.20 \\ \hline
Household$\_$receive$\_$info$\_$interest$\_$from$\_$bank & Household$\_$received$\_$coupons & SELECTSTRATEGY &  0.79 & 0.20 \\ \hline
\parbox[t]{6cm}{Firm$\_$read$\_$job$\_$applications$\_$send$\_$\\[-4pt]job$\_$offer$\_$or$\_$rejection}  & 03 & 04 &  0.62 & 0.15 \\ \hline
\end{tabular}
}
\caption{Revision \textbf{2723}, Serial, 240 iterations, small population. Total run time 6:42[m:s]\label{table:r2723}}
\end{center}
\end{table}


\begin{table}
\begin{center}
{\small\renewcommand{\arraystretch}{1.3}
\begin{tabular}{|p{70mm}|p{70mm}|p{70mm}|c|c|}\hline
Function & State from & State to & Time (s) & \% \\ \hline
Household$\_$send$\_$orders & SEND$\_$ORDERS & WAITORDERSTATUS &  63.8842 & 33.3 \\ \hline
ClearingHouse$\_$receive$\_$orders$\_$and$\_$run & RECEIVEDINFOSTOCK & COMPUTEDPRICES &  59.7536 & 31.1 \\ \hline
Household$\_$stock$\_$beliefs$\_$formation & CHOOSE$\_$TO$\_$UPDATE$\_$BELIEFS$\_$OR$\_$NOT & BOND$\_$BELIEF$\_$FORMATION &   8.82473 & 4.6 \\ \hline
Household$\_$rank$\_$and$\_$buy$\_$goods$\_$1 & 09 & 09b &   5.23093 & 2.7 \\ \hline
\parbox[t]{6cm}{Firm$\_$read$\_$job$\_$applications$\_$send$\_$job$\_$\\[-4pt]offer$\_$or$\_$rejection} & 03 & 04 &   1.41734 & 0.7 \\ \hline
Household$\_$receive$\_$dividends & 06 & 06b &   1.38099 & 0.7 \\ \hline
\parbox[t]{6cm}{Household$\_$receive$\_$info$\_$interest$\_$\\[-4pt]from$\_$bank} & Household$\_$received$\_$coupons & SELECTSTRATEGY &   1.14297 & 0.6 \\ \hline
Household$\_$update$\_$its$\_$portfolio & WAITORDERSTATUS & Household$\_$Start$\_$Labour$\_$Role &   1.11446 & 0.6 \\ \hline
Household$\_$receive$\_$data & Household$\_$Start$\_$Policy$\_$Data & Household$\_$Start$\_$Financial$\_$Market$\_$Role &   0.619365 & 0.3 \\ \hline
Household$\_$send$\_$account$\_$update & 15 & 16 &   0.607822 & 0.3 \\ \hline
\end{tabular}
}
\caption{Revision \textbf{2772}, Serial, 240 iterations, small population. Total run time 3:12[m:s]}
\end{center}
\end{table}


\begin{table}
\begin{center}
{\small\renewcommand{\arraystretch}{1.3}
\begin{tabular}{|p{70mm}|p{70mm}|p{70mm}|c|c|}\hline
Function & State from & State to & Time (s) & \% \\ \hline
Household$\_$send$\_$orders & SEND$\_$ORDERS & WAITORDERSTATUS &  77.95 & 37.5 \\ \hline
ClearingHouse$\_$receive$\_$orders$\_$and$\_$run & RECEIVEDINFOSTOCK & COMPUTEDPRICES &   54.51 & 26.2 \\ \hline
Household$\_$stock$\_$beliefs$\_$formation & \parbox[t]{6cm}{CHOOSE$\_$TO$\_$UPDATE$\_$BELIEFS$\_$\\[-4pt]OR$\_$NOT} & BOND$\_$BELIEF$\_$FORMATION &   9.83 & 4.7 \\ \hline
Household$\_$rank$\_$and$\_$buy$\_$goods$\_$1 & 09 & 09b &   3.91 & 1.9 \\ \hline
Household$\_$receive$\_$dividends & 06 & 06b &   1.47 & 0.7 \\ \hline
Household$\_$update$\_$its$\_$portfolio & WAITORDERSTATUS & Household$\_$Start$\_$Labour$\_$Role &   1.34 & 0.6 \\ \hline
\parbox[t]{6cm}{Firm$\_$read$\_$job$\_$applications$\_$send$\_$job$\_$\\[-4pt]offer$\_$or$\_$rejection} & 03 & 04 &   0.98 & 0.5 \\ \hline
Household$\_$select$\_$strategy & SELECTSTRATEGY & CHOOSE$\_$TO$\_$UPDATE$\_$BELIEFS$\_$OR$\_$NOT &   0.8 & 0.4 \\ \hline
\parbox[t]{6cm}{Household$\_$receive$\_$info$\_$interest$\_$\\[-4pt]from$\_$bank} & Household$\_$received$\_$coupons & REVISE$\_$PORTFOLIO &   0.76 & 0.4 \\ \hline
Household$\_$send$\_$account$\_$update & 15 & 16 &  0.64 & 0.3 \\ \hline
\end{tabular}
}
\caption{Revision \textbf{2802}, Serial, 240 iterations, small population. Total run time 3:28[m:s]}
\end{center}
\end{table}

\end{landscape}

\subsection{Parallel Performance Analysis}

\begin{landscape}
\begin{table}
\begin{center}
{\small\renewcommand{\arraystretch}{1.3}
\begin{tabular}{|p{70mm}|p{70mm}|p{70mm}|c|c|}\hline
Function & State from & State to & Time (s) & \% \\ \hline
Household$\_$send$\_$orders & SEND$\_$ORDERS & WAITORDERSTATUS &   2083.3 & 14.2 \\ \hline
Household$\_$stock$\_$beliefs$\_$formation & CHOOSE$\_$TO$\_$UPDATE$\_$BELIEFS$\_$OR$\_$NOT & BOND$\_$BELIEF$\_$FORMATION &   211.144 & 1.4 \\ \hline
order &  &  &   137.024 & 0.9 \\ \hline
Household$\_$receive$\_$dividends & 06 & 06b &   104.891 & 0.7 \\ \hline
Household$\_$receive$\_$data & Household$\_$Start$\_$Policy$\_$Data & Household$\_$Start$\_$Financial$\_$Market$\_$Role &   43.6602 & 0.3 \\ \hline
Household$\_$receive$\_$info$\_$interest$\_$from$\_$bank & Household$\_$received$\_$coupons & SELECTSTRATEGY &   37.1621 & 0.3 \\ \hline
Household$\_$update$\_$its$\_$portfolio & WAITORDERSTATUS & Household$\_$Start$\_$Labour$\_$Role &   34.5611 & 0.2 \\ \hline
Firm$\_$read$\_$stock$\_$transactions & 0003 & End$\_$Firm$\_$Financial$\_$Role &   17.7424 & 0.1 \\ \hline
Household$\_$rank$\_$and$\_$buy$\_$goods$\_$1 & 09 & 09b &   16.1013 & 0.1 \\ \hline
Household$\_$send$\_$account$\_$update & 15 & 16 &   16.049 & 0.1 \\ \hline
\end{tabular}
}
\caption{Revision \textbf{2754}, Parallel, 240 iterations, 16 region population. Total run time 244:25[m:s]. Node 0\label{table:r2754_0}}
\end{center}
\end{table}


\begin{table}
\begin{center}
{\footnotesize\renewcommand{\arraystretch}{1.3}
\begin{tabular}{|p{70mm}|p{70mm}|p{70mm}|c|c|}\hline
Function & State from & State to & Time (s) & \% \\ \hline
ClearingHouse$\_$receive$\_$orders$\_$and$\_$run & RECEIVEDINFOSTOCK & COMPUTEDPRICES &   5125.29 & 35.0 \\ \hline
Household$\_$send$\_$orders & SEND$\_$ORDERS & WAITORDERSTATUS &   2067.41 & 14.1 \\ \hline
Household$\_$stock$\_$beliefs$\_$formation & CHOOSE$\_$TO$\_$UPDATE$\_$BELIEFS$\_$OR$\_$NOT & BOND$\_$BELIEF$\_$FORMATION &  222.105 & 1.5 \\ \hline
Household$\_$receive$\_$dividends & 06 & 06b &   104.267 & 0.7 \\ \hline
order &  &  &   75.312 & 0.5 \\ \hline
Household$\_$receive$\_$data & Household$\_$Start$\_$Policy$\_$Data & Household$\_$Start$\_$Financial$\_$Market$\_$Role &   43.5033 & 0.3 \\ \hline
Household$\_$receive$\_$info$\_$interest$\_$from$\_$bank & Household$\_$received$\_$coupons & SELECTSTRATEGY &   37.0695 & 0.3 \\ \hline
Household$\_$update$\_$its$\_$portfolio & WAITORDERSTATUS & Household$\_$Start$\_$Labour$\_$Role &   34.4162 & 0.2 \\ \hline
Household$\_$rank$\_$and$\_$buy$\_$goods$\_$1 & 09 & 09b &   16.4965 & 0.1 \\ \hline
Firm$\_$read$\_$stock$\_$transactions & 0003 & End$\_$Firm$\_$Financial$\_$Role &   15.9953 & 0.1 \\ \hline
\end{tabular}
}\caption{Revision \textbf{2754}, Parallel, 240 iterations, 16 region population. Total run time 244:25[m:s]. Node 1\label{table:r2754_1}}
\end{center}
\end{table}

\end{landscape}

